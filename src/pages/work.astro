---
import Layout from '@/layouts/Layout.astro';
import ArtworkFilters from '@/components/ui/ArtworkFilters.astro';
import ArtworkGrid from '@/components/ui/ArtworkGrid.astro';
import ArtworkPagination from '@/components/ui/ArtworkPagination.astro';
import ArtworkLightbox from '@/components/ui/ArtworkLightbox.astro';
import { artworks } from '@/data/artworks';

const locale = Astro.currentLocale || 'es';

// Initial page load shows first 25 items
const ITEMS_PER_PAGE = 25;
const initialArtworks = artworks.slice(0, ITEMS_PER_PAGE);
const totalPages = Math.ceil(artworks.length / ITEMS_PER_PAGE);
---

<Layout
	title={locale === 'es' ? 'La Obra de Remedios Varo' : 'The Work of Remedios Varo'}
	description={locale === 'es'
		? 'Explora la colecci칩n completa de obras de Remedios Varo, la artista surrealista espa침ola-mexicana.'
		: 'Explore the complete collection of works by Remedios Varo, the Spanish-Mexican surrealist artist.'}
>
	<section class='mb-12'>
		<h1 class='text-4xl font-bold mb-4 border-b-2 border-primary pb-3'>
			{locale === 'es' ? 'La Obra' : 'The Work'}
		</h1>
		<p class='text-lg text-base-content/80 mb-8'>
			{locale === 'es'
				? 'Explora la fascinante colecci칩n de obras de Remedios Varo. Utiliza los filtros para descubrir pinturas, dibujos y m치s.'
				: 'Explore the fascinating collection of works by Remedios Varo. Use the filters to discover paintings, drawings, and more.'}
		</p>

		<!-- Filters -->
		<ArtworkFilters artworks={artworks} locale={locale} />

		<!-- Grid -->
		<div id="artwork-grid-container">
			<ArtworkGrid artworks={initialArtworks} locale={locale} />
		</div>

		<!-- Pagination -->
		<div id="pagination-container">
			<ArtworkPagination
				currentPage={1}
				totalPages={totalPages}
				totalItems={artworks.length}
				locale={locale}
			/>
		</div>

		<!-- Lightbox Modal -->
		<ArtworkLightbox locale={locale} />
	</section>
</Layout>

<script define:vars={{ artworks, locale, ITEMS_PER_PAGE }}>
	// Client-side state
	let currentPage = 1;
	let filteredArtworks = [...artworks];
	let currentFilters = {
		searchQuery: '',
		types: [],
		tags: [],
		yearMin: null,
		yearMax: null,
		sortBy: 'year-desc'
	};

	// Initialize
	document.addEventListener('DOMContentLoaded', () => {
		initializeFilters();
		initializePagination();
		initializeLightbox();
	});

	// Filter functions
	function filterArtworks() {
		let results = [...artworks];

		// Search filter
		if (currentFilters.searchQuery) {
			const query = currentFilters.searchQuery.toLowerCase();
			results = results.filter(artwork => {
				const matchesTitle = artwork.title.toLowerCase().includes(query);
				const matchesTitleEs = artwork.titleEs?.toLowerCase().includes(query);
				return matchesTitle || matchesTitleEs;
			});
		}

		// Type filter
		if (currentFilters.types.length > 0) {
			results = results.filter(artwork => currentFilters.types.includes(artwork.type));
		}

		// Tags filter
		if (currentFilters.tags.length > 0) {
			results = results.filter(artwork =>
				currentFilters.tags.some(tag => artwork.tags.includes(tag))
			);
		}

		// Year range filter
		if (currentFilters.yearMin) {
			results = results.filter(artwork => artwork.year >= currentFilters.yearMin);
		}
		if (currentFilters.yearMax) {
			results = results.filter(artwork => artwork.year <= currentFilters.yearMax);
		}

		// Sort
		results = sortArtworks(results, currentFilters.sortBy);

		filteredArtworks = results;
		currentPage = 1; // Reset to first page
		updateDisplay();
	}

	function sortArtworks(artworks, sortBy) {
		const sorted = [...artworks];

		switch (sortBy) {
			case 'year-asc':
				return sorted.sort((a, b) => a.year - b.year);
			case 'year-desc':
				return sorted.sort((a, b) => b.year - a.year);
			case 'title-asc':
				return sorted.sort((a, b) => a.title.localeCompare(b.title));
			case 'title-desc':
				return sorted.sort((a, b) => b.title.localeCompare(a.title));
			default:
				return sorted;
		}
	}

	function updateDisplay() {
		// Update grid
		const startIdx = (currentPage - 1) * ITEMS_PER_PAGE;
		const endIdx = startIdx + ITEMS_PER_PAGE;
		const pageArtworks = filteredArtworks.slice(startIdx, endIdx);

		renderGrid(pageArtworks);
		renderPagination();
		updateResultsCount();

		// Scroll to top of grid
		document.getElementById('artwork-grid-container')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
	}

	function renderGrid(artworks) {
		const container = document.getElementById('artwork-grid-container');
		if (!container) return;

		if (artworks.length === 0) {
			container.innerHTML = `
				<div class="text-center py-12">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-base-content/30 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
					</svg>
					<p class="text-lg text-base-content/70">
						${locale === 'es' ? 'No se encontraron obras con estos filtros' : 'No artworks found with these filters'}
					</p>
					<button id="reset-filters-btn" class="btn btn-outline btn-sm mt-4">
						${locale === 'es' ? 'Restablecer filtros' : 'Reset filters'}
					</button>
				</div>
			`;

			// Re-attach reset handler
			document.getElementById('reset-filters-btn')?.addEventListener('click', resetFilters);
			return;
		}

		// Simple reload - in production, you might want to use a more sophisticated approach
		window.location.href = window.location.pathname + `?page=${currentPage}&filters=${encodeURIComponent(JSON.stringify(currentFilters))}`;
	}

	function renderPagination() {
		// Update pagination display
		const totalPages = Math.ceil(filteredArtworks.length / ITEMS_PER_PAGE);
		const container = document.getElementById('pagination-container');
		if (!container) return;

		if (totalPages <= 1) {
			container.style.display = 'none';
			return;
		}

		container.style.display = 'block';

		// Update button states
		const prevBtn = document.getElementById('prev-page-btn');
		const nextBtn = document.getElementById('next-page-btn');

		if (prevBtn) prevBtn.disabled = currentPage === 1;
		if (nextBtn) nextBtn.disabled = currentPage === totalPages;

		// Update active page buttons
		document.querySelectorAll('.page-btn').forEach(btn => {
			const page = parseInt(btn.dataset.page);
			if (page === currentPage) {
				btn.classList.add('btn-active');
			} else {
				btn.classList.remove('btn-active');
			}
		});
	}

	function updateResultsCount() {
		const countElem = document.getElementById('showing-count');
		if (countElem) {
			countElem.textContent = filteredArtworks.length;
		}
	}

	function resetFilters() {
		// Reset form inputs
		document.getElementById('search-input').value = '';
		document.getElementById('sort-select').value = 'year-desc';
		document.getElementById('year-min').value = document.getElementById('year-min').min;
		document.getElementById('year-max').value = document.getElementById('year-max').max;

		document.querySelectorAll('.type-filter').forEach(cb => cb.checked = true);
		document.querySelectorAll('.tag-filter').forEach(cb => cb.checked = false);

		// Reset state
		currentFilters = {
			searchQuery: '',
			types: [],
			tags: [],
			yearMin: null,
			yearMax: null,
			sortBy: 'year-desc'
		};

		filterArtworks();
	}

	// Initialize event listeners
	function initializeFilters() {
		// Search
		const searchInput = document.getElementById('search-input');
		let searchTimeout;
		searchInput?.addEventListener('input', (e) => {
			clearTimeout(searchTimeout);
			searchTimeout = setTimeout(() => {
				currentFilters.searchQuery = e.target.value;
				filterArtworks();
			}, 300);
		});

		// Sort
		document.getElementById('sort-select')?.addEventListener('change', (e) => {
			currentFilters.sortBy = e.target.value;
			filterArtworks();
		});

		// Type filters
		document.querySelectorAll('.type-filter').forEach(checkbox => {
			checkbox.addEventListener('change', () => {
				currentFilters.types = Array.from(document.querySelectorAll('.type-filter:checked'))
					.map(cb => cb.dataset.type);
				filterArtworks();
			});
		});

		// Tag filters
		document.querySelectorAll('.tag-filter').forEach(checkbox => {
			checkbox.addEventListener('change', () => {
				currentFilters.tags = Array.from(document.querySelectorAll('.tag-filter:checked'))
					.map(cb => cb.dataset.tag);
				filterArtworks();
			});
		});

		// Year filters
		document.getElementById('year-min')?.addEventListener('change', (e) => {
			currentFilters.yearMin = parseInt(e.target.value) || null;
			filterArtworks();
		});

		document.getElementById('year-max')?.addEventListener('change', (e) => {
			currentFilters.yearMax = parseInt(e.target.value) || null;
			filterArtworks();
		});

		// Reset button
		document.getElementById('reset-all-filters')?.addEventListener('click', resetFilters);
	}

	function initializePagination() {
		// Page buttons
		document.querySelectorAll('.page-btn').forEach(btn => {
			btn.addEventListener('click', () => {
				currentPage = parseInt(btn.dataset.page);
				updateDisplay();
			});
		});

		// Prev/Next buttons
		document.getElementById('prev-page-btn')?.addEventListener('click', (e) => {
			const page = parseInt(e.currentTarget.dataset.page);
			if (page > 0) {
				currentPage = page;
				updateDisplay();
			}
		});

		document.getElementById('next-page-btn')?.addEventListener('click', (e) => {
			const page = parseInt(e.currentTarget.dataset.page);
			const totalPages = Math.ceil(filteredArtworks.length / ITEMS_PER_PAGE);
			if (page <= totalPages) {
				currentPage = page;
				updateDisplay();
			}
		});
	}

	function initializeLightbox() {
		const lightbox = document.getElementById('artwork-lightbox');
		const closeBtn = document.getElementById('close-lightbox');
		const backdrop = document.getElementById('lightbox-backdrop');
		const prevBtn = document.getElementById('lightbox-prev');
		const nextBtn = document.getElementById('lightbox-next');

		let currentArtworkIndex = 0;

		// Open lightbox
		document.addEventListener('click', (e) => {
			if (e.target.closest('.open-lightbox') || e.target.closest('.artwork-card')) {
				const card = e.target.closest('.artwork-card');
				if (card) {
					const artworkId = card.dataset.artworkId;
					const artwork = artworks.find(a => a.id === artworkId);
					if (artwork) {
						currentArtworkIndex = artworks.indexOf(artwork);
						showLightbox(artwork);
					}
				}
			}
		});

		// Close lightbox
		closeBtn?.addEventListener('click', closeLightbox);
		backdrop?.addEventListener('click', closeLightbox);

		// Navigation
		prevBtn?.addEventListener('click', () => {
			currentArtworkIndex = (currentArtworkIndex - 1 + artworks.length) % artworks.length;
			showLightbox(artworks[currentArtworkIndex]);
		});

		nextBtn?.addEventListener('click', () => {
			currentArtworkIndex = (currentArtworkIndex + 1) % artworks.length;
			showLightbox(artworks[currentArtworkIndex]);
		});

		// Keyboard navigation
		document.addEventListener('keydown', (e) => {
			if (!lightbox.classList.contains('modal-open')) return;

			if (e.key === 'Escape') closeLightbox();
			if (e.key === 'ArrowLeft') prevBtn?.click();
			if (e.key === 'ArrowRight') nextBtn?.click();
		});

		function showLightbox(artwork) {
			const title = locale === 'es' && artwork.titleEs ? artwork.titleEs : artwork.title;
			const description = locale === 'es' && artwork.descriptionEs ? artwork.descriptionEs : artwork.description;

			document.getElementById('lightbox-image').src = `/src/assets/work/${artwork.imagePath}`;
			document.getElementById('lightbox-image').alt = title;
			document.getElementById('lightbox-title').textContent = title;
			document.getElementById('lightbox-year').textContent = artwork.year;
			document.getElementById('lightbox-type').textContent = artwork.type;

			// Optional fields
			const mediumContainer = document.getElementById('lightbox-medium-container');
			if (artwork.medium) {
				document.getElementById('lightbox-medium').textContent = artwork.medium;
				mediumContainer.style.display = 'flex';
			} else {
				mediumContainer.style.display = 'none';
			}

			const collectionContainer = document.getElementById('lightbox-collection-container');
			if (artwork.collection) {
				document.getElementById('lightbox-collection').textContent = artwork.collection;
				collectionContainer.style.display = 'flex';
			} else {
				collectionContainer.style.display = 'none';
			}

			const descriptionContainer = document.getElementById('lightbox-description-container');
			if (description) {
				document.getElementById('lightbox-description').textContent = description;
				descriptionContainer.style.display = 'block';
			} else {
				descriptionContainer.style.display = 'none';
			}

			// Tags
			const tagsContainer = document.getElementById('lightbox-tags');
			tagsContainer.innerHTML = artwork.tags.map(tag =>
				`<div class="badge badge-outline">${tag.replace(/-/g, ' ')}</div>`
			).join('');

			lightbox.classList.add('modal-open');
		}

		function closeLightbox() {
			lightbox.classList.remove('modal-open');
		}
	}
</script>
