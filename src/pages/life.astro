---
import Layout from '@/layouts/Layout.astro'
import LifeEventsTimeline from '@/components/ui/LifeEventsTimeline.astro'
import Carousel from '@/components/solid/Carousel'
import type { CarouselImage } from '@/components/solid/Carousel'
import type { LifeEvent } from '../types/cv'
import { getCvTranslations, useTranslations, type Locale } from '@/i18n/translations'
import { getImage } from 'astro:assets'

const currentLocale = (Astro.currentLocale || 'es') as Locale
const t = useTranslations(currentLocale)
const cvData = getCvTranslations(currentLocale)

// Dynamically import all images from the life folder
const lifeImagesGlob = import.meta.glob('../assets/life/*.{png,jpg,jpeg,webp,gif}', { eager: true })

// Merge images with their captions from translations
// Sort by filename to ensure consistent ordering
// Process images with getImage to get optimized URLs for the Solid component
const carouselImagesPromises = Object.entries(lifeImagesGlob)
  .sort(([pathA], [pathB]) => {
    const filenameA = pathA.split('/').pop() || ''
    const filenameB = pathB.split('/').pop() || ''
    return filenameA.localeCompare(filenameB)
  })
  .map(async ([path, mod]: [string, any]) => {
    const filename = path.split('/').pop() || ''
    const caption = cvData.lifePhotos[filename as keyof typeof cvData.lifePhotos]

    // Get optimized image
    const optimizedImage = await getImage({ src: mod.default })

    return {
      src: optimizedImage.src,
      title: caption?.title || '',
      year: caption?.year || '',
      description: caption?.description || '',
      alt: caption?.title || 'Remedios Varo life photo',
    }
  })

const carouselImages: CarouselImage[] = await Promise.all(carouselImagesPromises)

let orderedLifeEvents: LifeEvent[] = []

const orderElement = <T extends { time: string }>(a: T, b: T) => {
  const presentValues = ['present', 'now', 'current', 'today']
  if (
			presentValues.includes(
				(a['time'] as string)?.split(' - ')[1]?.toLowerCase()
			)
		) {
			// If the date is 'present', it should be the first element
			return -1
		}
		const dateA = new Date((a['time'] as string)?.split(' - ')[1])
		const dateB = new Date((b['time'] as string)?.split(' - ')[1])
		return dateB.getTime() - dateA.getTime()
}

if (cvData.lifeEvents.length > 0) {
	orderedLifeEvents = cvData.lifeEvents.sort((a, b) => {
		return orderElement(a, b)
	})
}

---

<Layout>
	{
		orderedLifeEvents.length > 0 && (
			<section class='mb-12'>
				<h2 class='text-2xl font-bold mb-6 border-b pb-2'>
				{t('cv.lifeEventsTitle')}
				</h2>
				<LifeEventsTimeline elements={orderedLifeEvents} colored={true} />
			</section>
		)
	}

	{
		carouselImages.length > 0 && (
			<section class='mb-12'>
				<h2 class='text-2xl font-bold mb-6 border-b pb-2'>
				{t('cv.photoGallery')}
				</h2>
				<Carousel images={carouselImages} height="600px" client:load />
			</section>
		)
	}
</Layout>
