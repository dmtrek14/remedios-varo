---
import { Image } from 'astro:assets'
import type { ImageMetadata } from 'astro'

export interface CarouselImage {
  image: ImageMetadata
  title?: string
  year?: string
  description?: string
}

interface Props {
  images: (ImageMetadata | CarouselImage)[]
  height?: string
  showControls?: boolean
  alt?: string
}

const { images, height = '500px', showControls = true, alt = 'Carousel image' } = Astro.props

// If no images provided, don't render
if (!images || images.length === 0) {
  return null
}

// Normalize images to CarouselImage format
const normalizedImages: CarouselImage[] = images.map(img => {
  if ('image' in img) {
    return img as CarouselImage
  }
  return { image: img as ImageMetadata }
})

// Generate a unique ID for this carousel instance
const carouselId = `carousel-${Math.random().toString(36).substring(2, 9)}`
---

<div class="w-full carousel-wrapper" data-carousel-id={carouselId}>
  <div class="carousel w-full" style={`height: ${height}; scroll-snap-type: x mandatory; overflow-x: auto; display: flex;`}>
    {normalizedImages.map((item, index) => {
      const slideId = `${carouselId}-slide-${index}`

      return (
        <div
          id={slideId}
          class="carousel-item relative w-full flex-shrink-0"
          data-slide-index={index}
          style="scroll-snap-align: start;"
        >
          <Image
            src={item.image}
            alt={item.title || `${alt} ${index + 1}`}
            class="w-full h-full object-contain"
            loading={index === 0 ? 'eager' : 'lazy'}
          />
          {showControls && normalizedImages.length > 1 && (
            <div class="absolute left-5 right-5 top-1/2 flex -translate-y-1/2 transform justify-between z-10">
              <button
                class="btn btn-circle carousel-btn-prev"
                data-carousel-id={carouselId}
                aria-label="Previous slide"
                type="button"
              >
                ❮
              </button>
              <button
                class="btn btn-circle carousel-btn-next"
                data-carousel-id={carouselId}
                aria-label="Next slide"
                type="button"
              >
                ❯
              </button>
            </div>
          )}
        </div>
      )
    })}
  </div>

  {/* Caption display - always visible below carousel */}
  <div class="w-full bg-base-200 p-4 text-center min-h-[4rem] flex items-center justify-center caption-container">
    {normalizedImages.map((item, index) => {
      return (
        <div
          class:list={["carousel-caption w-full", { hidden: index !== 0 }]}
          data-caption-index={index}
        >
          {item.title && item.year ? (
            <p class="font-semibold text-lg">
              {item.title} ({item.year})
            </p>
          ) : item.title ? (
            <p class="font-semibold text-lg">{item.title}</p>
          ) : item.year ? (
            <p class="font-semibold text-lg">{item.year}</p>
          ) : (
            <p class="text-base-content/50 italic">No caption</p>
          )}
          {item.description && (
            <p class="text-sm text-base-content/70 mt-1">{item.description}</p>
          )}
        </div>
      )
    })}
  </div>

  {normalizedImages.length > 1 && (
    <div class="flex w-full justify-center gap-2 py-2">
      {normalizedImages.map((_, index) => (
        <button
          class="btn btn-xs carousel-dot"
          data-slide-index={index}
          data-carousel-id={carouselId}
          type="button"
        >
          {index + 1}
        </button>
      ))}
    </div>
  )}
</div>

<script is:inline>
  document.addEventListener('DOMContentLoaded', function() {
    const carouselWrappers = document.querySelectorAll('.carousel-wrapper');

    carouselWrappers.forEach(wrapper => {
      const carouselId = wrapper.getAttribute('data-carousel-id');
      const carousel = wrapper.querySelector('.carousel');
      const captionContainer = wrapper.querySelector('.caption-container');
      const slides = Array.from(carousel.querySelectorAll('.carousel-item'));
      const captions = captionContainer.querySelectorAll('.carousel-caption');
      const prevBtns = wrapper.querySelectorAll('.carousel-btn-prev');
      const nextBtns = wrapper.querySelectorAll('.carousel-btn-next');
      const dots = wrapper.querySelectorAll('.carousel-dot');

      let currentSlide = 0;

      function scrollToSlide(index) {
        if (index < 0 || index >= slides.length) return;

        const slide = slides[index];
        if (slide) {
          carousel.scrollTo({
            left: slide.offsetLeft,
            behavior: 'smooth'
          });
        }
      }

      function updateCaption(slideIndex) {
        // Hide all captions
        captions.forEach(caption => {
          caption.classList.add('hidden');
        });

        // Show the matching caption
        const targetCaption = captionContainer.querySelector(`[data-caption-index="${slideIndex}"]`);
        if (targetCaption) {
          targetCaption.classList.remove('hidden');
        }

        currentSlide = slideIndex;
      }

      // Previous buttons (there's one on each slide)
      prevBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const newIndex = currentSlide === 0 ? slides.length - 1 : currentSlide - 1;
          scrollToSlide(newIndex);
        });
      });

      // Next buttons (there's one on each slide)
      nextBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const newIndex = currentSlide === slides.length - 1 ? 0 : currentSlide + 1;
          scrollToSlide(newIndex);
        });
      });

      // Dot navigation
      dots.forEach(dot => {
        dot.addEventListener('click', (e) => {
          e.preventDefault();
          const index = parseInt(dot.getAttribute('data-slide-index'), 10);
          scrollToSlide(index);
        });
      });

      // Use Intersection Observer to detect which slide is visible
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && entry.intersectionRatio > 0.5) {
            const slideIndex = parseInt(entry.target.getAttribute('data-slide-index'), 10);
            updateCaption(slideIndex);
          }
        });
      }, {
        root: carousel,
        threshold: 0.5
      });

      // Observe all slides
      slides.forEach(slide => {
        observer.observe(slide);
      });
    });
  });
</script>
